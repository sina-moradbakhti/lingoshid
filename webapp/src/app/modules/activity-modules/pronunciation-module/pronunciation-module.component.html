<div class="pronunciation-module">
  <!-- Header -->
  <div class="module-header">
    <h2>üé§ {{ config.title }}</h2>
    <p>{{ config.description }}</p>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <span class="progress-text">Stage {{ currentStage }}/{{ getTotalStages() }}</span>
    </div>
  </div>

  <!-- Current Word Display -->
  <div class="word-display" *ngIf="currentWord && !showingFeedback">
    <div class="target-word">
      <h3>{{ currentWord.word }}</h3>
      <p class="phonetic" *ngIf="currentWord.phonetic">{{ currentWord.phonetic }}</p>
    </div>

    <!-- Audio Controls -->
    <div class="audio-controls">
      <button
        (click)="playAudio()"
        class="play-btn"
        [class.playing]="isPlaying"
        [disabled]="isRecording">
        <span *ngIf="!isPlaying">üîä Listen</span>
        <span *ngIf="isPlaying">‚è∏Ô∏è Stop</span>
      </button>
    </div>

    <!-- Recording Controls -->
    <div class="recording-section">
      <button
        (click)="isRecording ? stopRecording() : startRecording()"
        class="record-btn"
        [class.recording]="isRecording"
        [disabled]="isProcessing || !hasListenedToCurrentWord">
        <span *ngIf="!isRecording">üé§ Start Recording</span>
        <span *ngIf="isRecording">‚èπÔ∏è Stop Recording ({{ recordingTime }}s)</span>
      </button>

      <p class="hint" *ngIf="!hasListenedToCurrentWord && !lastFeedback">
        üëÜ Click "Listen" first to hear the correct pronunciation
      </p>

      <p class="hint" *ngIf="hasListenedToCurrentWord && !isRecording && !lastFeedback">
        Click the microphone and say the word clearly
      </p>
    </div>
  </div>

  <!-- Feedback Display -->
  <div class="feedback-section" *ngIf="lastFeedback && showingFeedback">
    <div class="feedback-card" [ngClass]="getScoreClass(lastFeedback.score)">

      <!-- Show current word at top for context -->
      <div class="feedback-word-context">
        <h3>{{ currentWord?.word }}</h3>
      </div>

      <div class="score-display">
        <div class="score-circle">
          <span class="score-value">{{ lastFeedback.score }}</span>
          <span class="score-label">%</span>
        </div>

        <!-- Confidence Percentage -->
        <div class="confidence-display" *ngIf="lastFeedback.confidence !== undefined && lastFeedback.confidence !== null">
          <div class="confidence-label">Confidence</div>
          <div class="confidence-value">{{ lastFeedback.confidence }}%</div>
          <div class="confidence-bar">
            <div class="confidence-fill"
                 [style.width.%]="lastFeedback.confidence"
                 [ngClass]="getScoreClass(lastFeedback.confidence)"></div>
          </div>
        </div>
      </div>

      <div class="feedback-content">
        <h4>{{ lastFeedback.message }}</h4>
        <p class="encouragement">{{ lastFeedback.encouragement }}</p>

        <div class="transcription" *ngIf="lastFeedback.transcript">
          <p><strong>You said:</strong> "{{ lastFeedback.transcript }}"</p>
          <p><strong>Target:</strong> "{{ lastFeedback.target }}"</p>
        </div>

        <div class="suggestions" *ngIf="lastFeedback.suggestions && lastFeedback.suggestions.length > 0">
          <p><strong>Tips:</strong></p>
          <ul>
            <li *ngFor="let suggestion of lastFeedback.suggestions">{{ suggestion }}</li>
          </ul>
        </div>
      </div>

      <!-- Auto-advance indicator -->
      <div class="auto-advance-notice" *ngIf="showingFeedback && currentStage < getTotalStages()">
        <p>‚è±Ô∏è Next word in 2 seconds...</p>
      </div>
    </div>

    <!-- Continue Button (Hidden during auto-advance) -->
    <div class="action-buttons" *ngIf="!showingFeedback || currentStage >= getTotalStages()">
      <button
        *ngIf="currentStage < getTotalStages()"
        (click)="nextStage()"
        class="next-btn">
        Next Word ‚Üí
      </button>

      <button
        *ngIf="currentStage >= getTotalStages()"
        (click)="completeActivity()"
        class="complete-btn">
        Complete Activity ‚úì
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading activity...</p>
  </div>

  <!-- Processing State -->
  <div class="processing" *ngIf="isProcessing">
    <div class="spinner"></div>
    <p>Processing your pronunciation...</p>
  </div>

  <!-- Error Display -->
  <div class="error-message" *ngIf="errorMessage">
    <p>‚ö†Ô∏è {{ errorMessage }}</p>
  </div>

  <!-- Exit Button -->
  <div class="footer-actions">
    <button (click)="onActivityExit()" class="exit-btn">
      ‚Üê Exit Activity
    </button>
  </div>
</div>

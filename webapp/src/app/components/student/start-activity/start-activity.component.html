    <div class="activity-runner">
      <!-- Header with Progress -->
      <div class="activity-header">
        <button (click)="exitActivity()" class="exit-btn" [class.disabled]="isProcessing">
          ‚Üê Exit Activity
        </button>
        <div class="activity-info" *ngIf="currentSession">
          <h2>{{ currentSession.activity.title }}</h2>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="progressPercentage"></div>
            </div>
            <span class="progress-text">{{ currentSession.currentStage }}/{{ currentSession.totalStages }}</span>
          </div>
        </div>
        <div class="score-display" *ngIf="currentSession">
          <span class="points">{{ currentSession.pointsEarned }} pts</span>
          <span class="score">{{ currentSession.currentScore }}%</span>
        </div>
      </div>

      <!-- Session Status Bar -->
      <div class="status-bar" *ngIf="currentSession">
        <div class="status-item">
          <span class="status-icon">‚è±Ô∏è</span>
          <span>{{ getFormattedTime(currentSession.timeSpent) }}</span>
        </div>
        <div class="status-item" *ngIf="isRecording">
          <div class="recording-indicator">
            <div class="pulse"></div>
            <span>Recording {{ recordingTime }}s</span>
          </div>
        </div>
        <div class="status-item" *ngIf="isListening">
          <span class="processing-indicator">
            <div class="spinner-small"></div>
            <span>Listening...</span>
          </span>
        </div>
      </div>

      <!-- Activity Content -->
      <div class="activity-content" *ngIf="currentSession && !isLoading">

        <!-- Pronunciation Challenge -->
        <div *ngIf="currentSession.activity.type === 'pronunciation_challenge'" class="pronunciation-activity">
          <div class="stage-header">
            <h3>üó£Ô∏è Pronunciation Challenge - Stage {{ currentSession.currentStage }}</h3>
            <p>Listen carefully and repeat what you hear</p>
          </div>

          <div class="pronunciation-content">
            <div class="target-word">
              <h4>{{ getCurrentWord() }}</h4>
              <p class="phonetic" *ngIf="getCurrentPhonetic()">{{ getCurrentPhonetic() }}</p>
            </div>

            <div class="audio-controls">
              <button (click)="playTargetAudio()" class="play-btn" [class.playing]="isPlaying">
                {{ isPlaying ? '‚è∏Ô∏è Stop' : 'üîä Listen' }}
              </button>
            </div>

            <div class="recording-section">
              <button
                (click)="toggleRecording()"
                class="record-btn"
                [class.recording]="isRecording"
                [disabled]="isProcessing">
                {{ isRecording ? '‚èπÔ∏è Stop Recording' : 'üé§ Start Recording' }}
              </button>
            </div>

            <!-- Real-time Feedback -->
            <div class="feedback-section" *ngIf="lastStageFeedback">
              <div class="score-card" [class]="lastStageFeedback.level">
                <div class="score-value">{{ lastStageFeedback.score }}%</div>
                <div class="score-text">{{ lastStageFeedback.message }}</div>
                <div class="audio-feedback" *ngIf="lastStageFeedback.audioFeedback">
                  <p><strong>What you said:</strong> "{{ lastStageFeedback.audioFeedback.transcription }}"</p>
                  <div class="pronunciation-tips" *ngIf="lastStageFeedback.audioFeedback.pronunciationTips.length > 0">
                    <p><strong>Tips:</strong></p>
                    <ul>
                      <li *ngFor="let tip of lastStageFeedback.audioFeedback.pronunciationTips">{{ tip }}</li>
                    </ul>
                  </div>
                </div>
                <div class="encouragement">{{ lastStageFeedback.encouragement }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Picture Description -->
        <div *ngIf="currentSession.activity.type === 'picture_description'" class="picture-activity">
          <div class="stage-header">
            <h3>üñºÔ∏è Picture Description - Stage {{ currentSession.currentStage }}</h3>
            <p>Describe what you see in the picture</p>
          </div>

          <div class="picture-content">
            <div class="picture-display">
              <img [src]="getCurrentPicture()" [alt]="'Picture ' + currentSession.currentStage" class="activity-image">
            </div>

            <div class="description-prompt">
              <h4>{{ getCurrentPrompt() }}</h4>
              <p class="helper-text">Use complete sentences and describe colors, objects, and actions you see.</p>
            </div>

            <div class="recording-section">
              <button
                (click)="toggleRecording()"
                class="record-btn large"
                [class.recording]="isRecording"
                [disabled]="isProcessing">
                {{ isRecording ? '‚èπÔ∏è Stop Recording' : 'üé§ Describe the Picture' }}
              </button>
            </div>

            <div class="vocabulary-hints" *ngIf="!isRecording && getCurrentVocabulary().length > 0">
              <h5>Helpful Words:</h5>
              <div class="word-chips">
                <span class="word-chip" *ngFor="let word of getCurrentVocabulary()">{{ word }}</span>
              </div>
            </div>

            <!-- Real-time Feedback -->
            <div class="feedback-section" *ngIf="lastStageFeedback">
              <div class="description-feedback">
                <div class="score-value">{{ lastStageFeedback.score }}%</div>
                <div class="transcription" *ngIf="lastStageFeedback.audioFeedback">
                  <p><strong>Your description:</strong></p>
                  <p class="transcription-text">"{{ lastStageFeedback.audioFeedback.transcription }}"</p>
                </div>
                <div class="feedback-message">{{ lastStageFeedback.message }}</div>
                <div class="suggestions" *ngIf="lastStageFeedback.suggestions.length > 0">
                  <p><strong>Suggestions:</strong></p>
                  <ul>
                    <li *ngFor="let suggestion of lastStageFeedback.suggestions">{{ suggestion }}</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Virtual Conversation -->
        <div *ngIf="currentSession.activity.type === 'virtual_conversation'" class="conversation-activity">
          <div class="stage-header">
            <h3>üí¨ Virtual Conversation - Stage {{ currentSession.currentStage }}</h3>
            <p>Have a conversation with {{ getCurrentCharacter().name }}</p>
          </div>

          <div class="conversation-content">
            <div class="character-display">
              <div class="avatar">{{ getCurrentCharacter().avatar }}</div>
              <h4>{{ getCurrentCharacter().name }}</h4>
              <p class="character-bio">{{ getCurrentCharacter().bio }}</p>
            </div>

            <div class="conversation-history">
              <div class="message"
                   *ngFor="let message of conversationHistory"
                   [class]="message.sender">
                <div class="message-content">{{ message.text }}</div>
                <div class="message-time">{{ message.timestamp | date:'short' }}</div>
              </div>
            </div>

            <div class="conversation-controls">
              <div class="current-prompt" *ngIf="currentConversationPrompt">
                <p><strong>{{ getCurrentCharacter().name }} says:</strong></p>
                <p class="character-speech">{{ currentConversationPrompt }}</p>
                <button (click)="playConversationAudio()" class="play-small-btn">üîä</button>
              </div>

              <div class="response-section">
                <button
                  (click)="toggleRecording()"
                  class="record-btn conversation"
                  [class.recording]="isRecording"
                  [disabled]="isProcessing">
                  {{ isRecording ? '‚èπÔ∏è Stop' : 'üé§ Respond' }}
                </button>
              </div>
            </div>

            <!-- Real-time Conversation Feedback -->
            <div class="feedback-section" *ngIf="lastStageFeedback">
              <div class="conversation-feedback">
                <div class="score-display">
                  <span class="fluency-score">Fluency: {{ getScoreComponent('fluency') }}%</span>
                  <span class="accuracy-score">Accuracy: {{ getScoreComponent('accuracy') }}%</span>
                </div>
                <div class="transcription" *ngIf="lastStageFeedback.audioFeedback">
                  <p><strong>Your response:</strong></p>
                  <p class="transcription-text">"{{ lastStageFeedback.audioFeedback.transcription }}"</p>
                </div>
                <div class="feedback-message">{{ lastStageFeedback.message }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Controls -->
        <div class="activity-navigation">
          <button
            (click)="previousStage()"
            class="nav-btn"
            [disabled]="currentSession.currentStage <= 1 || isProcessing">
            ‚Üê Previous
          </button>

          <button
            (click)="nextStage()"
            class="nav-btn primary"
            [disabled]="!canProceed() || isProcessing">
            {{ currentSession.currentStage >= currentSession.totalStages ? 'Complete Activity' : 'Next ‚Üí' }}
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading" *ngIf="isLoading">
        <div class="spinner">üéÆ</div>
        <p>{{ loadingMessage }}</p>
      </div>

      <!-- Error State -->
      <div class="error-state" *ngIf="!isLoading && !currentSession && errorMessage">
        <div class="error-icon">‚ùå</div>
        <h3>{{ errorMessage }}</h3>
        <p>Please try again or go back to activities.</p>
        <button (click)="goBack()" class="retry-btn">Go Back</button>
      </div>

      <!-- Completion Modal -->
      <div class="completion-modal" *ngIf="showCompletionModal" (click)="closeCompletionModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="completion-header">
            <h2>üéâ Activity Complete!</h2>
            <p>Great job on completing {{ currentSession?.activity?.title }}!</p>
          </div>

          <div class="completion-stats" *ngIf="completionResult">
            <div class="stat-item">
              <div class="stat-value">{{ completionResult.finalScore || completionResult.score || 0 }}%</div>
              <div class="stat-label">Final Score</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ completionResult.pointsEarned }}</div>
              <div class="stat-label">Points Earned</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ getFormattedTime(completionResult.timeSpent) }}</div>
              <div class="stat-label">Time Spent</div>
            </div>
          </div>

          <div class="detailed-feedback" *ngIf="completionResult?.message">
            <h3>Your Performance</h3>
            <p class="feedback-message">{{ completionResult.message }}</p>

            <div class="achievements" *ngIf="completionResult.achievements?.length > 0">
              <h4>üèÜ New Achievements!</h4>
              <div class="achievement-list">
                <div class="achievement-item" *ngFor="let achievement of completionResult.achievements">
                  {{ achievement.icon }} {{ achievement.name }}
                </div>
              </div>
            </div>

            <div class="improvement-tips" *ngIf="completionResult.improvement?.length > 0">
              <h4>üí° Tips for Improvement</h4>
              <ul>
                <li *ngFor="let tip of completionResult.improvement">{{ tip }}</li>
              </ul>
            </div>
          </div>

          <div class="completion-actions">
            <button (click)="tryAgain()" class="secondary-btn">Try Again</button>
            <button (click)="goToActivities()" class="primary-btn">Continue Learning</button>
          </div>
        </div>
      </div>
    </div>
